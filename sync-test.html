<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®åŒæ­¥æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .warning { background-color: #fff3cd; color: #856404; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .device-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        @media (max-width: 600px) {
            .device-info {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <h1>ğŸ“±ğŸ’» æ•°æ®åŒæ­¥æµ‹è¯•å·¥å…·</h1>
    
    <div class="test-container">
        <h2>è®¾å¤‡ä¿¡æ¯</h2>
        <div class="device-info">
            <div>
                <strong>å½“å‰è®¾å¤‡:</strong>
                <div id="device-info"></div>
            </div>
            <div>
                <strong>ç½‘ç»œä¿¡æ¯:</strong>
                <div id="network-info"></div>
            </div>
        </div>
    </div>
    
    <div class="test-container">
        <h2>å­˜å‚¨çŠ¶æ€æ£€æŸ¥</h2>
        <button onclick="checkStorageStatus()">æ£€æŸ¥å­˜å‚¨çŠ¶æ€</button>
        <button onclick="testDataSync()">æµ‹è¯•æ•°æ®åŒæ­¥</button>
        <div id="storage-status"></div>
    </div>
    
    <div class="test-container">
        <h2>æ•°æ®å¯¹æ¯”</h2>
        <button onclick="compareData()">å¯¹æ¯”æœ¬åœ°ä¸äº‘ç«¯æ•°æ®</button>
        <div id="data-comparison"></div>
    </div>
    
    <div class="test-container">
        <h2>åŒæ­¥æ“ä½œ</h2>
        <button onclick="forceUseKV()">å¼ºåˆ¶ä½¿ç”¨KVå­˜å‚¨</button>
        <button onclick="forceUseLocal()">å¼ºåˆ¶ä½¿ç”¨æœ¬åœ°å­˜å‚¨</button>
        <button onclick="syncLocalToKV()">åŒæ­¥æœ¬åœ°æ•°æ®åˆ°KV</button>
        <button onclick="syncKVToLocal()">åŒæ­¥KVæ•°æ®åˆ°æœ¬åœ°</button>
        <div id="sync-results"></div>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„è„šæœ¬ -->
    <script src="config.js"></script>
    <script src="blog-manager.js"></script>
    <script src="cloudflare-kv-manager.js"></script>
    <script src="blog-manager-kv.js"></script>
    <script src="api-client.js"></script>
    <script src="hybrid-blog-manager.js"></script>
    
    <script>
        let hybridManager;
        let localManager;
        let kvManager;
        
        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºè®¾å¤‡ä¿¡æ¯
        window.addEventListener('DOMContentLoaded', function() {
            displayDeviceInfo();
            initializeManagers();
        });
        
        function displayDeviceInfo() {
            const deviceDiv = document.getElementById('device-info');
            const networkDiv = document.getElementById('network-info');
            
            // æ£€æµ‹è®¾å¤‡ç±»å‹
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const isTablet = /iPad|Android/i.test(navigator.userAgent) && window.innerWidth > 600;
            
            deviceDiv.innerHTML = `
                ç±»å‹: ${isMobile ? (isTablet ? 'å¹³æ¿' : 'æ‰‹æœº') : 'ç”µè„‘'}<br>
                ç”¨æˆ·ä»£ç†: ${navigator.userAgent.substring(0, 50)}...<br>
                å±å¹•: ${window.innerWidth}x${window.innerHeight}
            `;
            
            networkDiv.innerHTML = `
                åŸŸå: ${window.location.hostname}<br>
                åè®®: ${window.location.protocol}<br>
                ç«¯å£: ${window.location.port || 'é»˜è®¤'}<br>
                å®Œæ•´URL: ${window.location.href}
            `;
        }
        
        async function initializeManagers() {
            try {
                hybridManager = new HybridBlogManager();
                localManager = new BlogManager();
                kvManager = new BlogManagerKV();
                
                await hybridManager.initialize();
                await kvManager.initialize();
                
                console.log('ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('åˆå§‹åŒ–ç®¡ç†å™¨å¤±è´¥:', error);
            }
        }
        
        async function checkStorageStatus() {
            const statusDiv = document.getElementById('storage-status');
            statusDiv.innerHTML = '<div class="info">æ­£åœ¨æ£€æŸ¥å­˜å‚¨çŠ¶æ€...</div>';
            
            try {
                const storageInfo = hybridManager.getStorageInfo();
                const apiClient = new APIClient();
                const apiInfo = apiClient.getAPIInfo();
                
                let statusClass = 'info';
                let statusText = '';
                
                if (storageInfo.type.includes('KV')) {
                    statusClass = 'success';
                    statusText = 'âœ… ä½¿ç”¨äº‘ç«¯KVå­˜å‚¨ - æ•°æ®ä¼šåŒæ­¥';
                } else {
                    statusClass = 'warning';
                    statusText = 'âš ï¸ ä½¿ç”¨æœ¬åœ°å­˜å‚¨ - æ•°æ®ä¸ä¼šåŒæ­¥';
                }
                
                statusDiv.innerHTML = `
                    <div class="${statusClass}">
                        ${statusText}<br><br>
                        <strong>è¯¦ç»†ä¿¡æ¯:</strong><br>
                        å­˜å‚¨ç±»å‹: ${storageInfo.type}<br>
                        åˆå§‹åŒ–çŠ¶æ€: ${storageInfo.initialized ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–'}<br>
                        APIåŸºç¡€URL: ${apiInfo.baseURL || 'æœªé…ç½®'}<br>
                        ç¯å¢ƒ: ${apiInfo.environment}
                    </div>
                `;
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">æ£€æŸ¥å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        async function testDataSync() {
            const statusDiv = document.getElementById('storage-status');
            statusDiv.innerHTML = '<div class="info">æ­£åœ¨æµ‹è¯•æ•°æ®åŒæ­¥...</div>';
            
            try {
                // åˆ›å»ºä¸€ä¸ªæµ‹è¯•æ–‡ç« 
                const testPost = {
                    title: `åŒæ­¥æµ‹è¯• - ${new Date().toLocaleString()}`,
                    content: `è¿™æ˜¯ä¸€ç¯‡ç”¨äºæµ‹è¯•æ•°æ®åŒæ­¥çš„æ–‡ç« ï¼Œåˆ›å»ºæ—¶é—´ï¼š${new Date().toISOString()}`,
                    summary: 'åŒæ­¥æµ‹è¯•æ–‡ç« ',
                    category: 'æµ‹è¯•',
                    tags: ['åŒæ­¥æµ‹è¯•', 'è®¾å¤‡æµ‹è¯•']
                };
                
                const result = await hybridManager.addPost(testPost);
                
                statusDiv.innerHTML = `
                    <div class="success">
                        âœ… æµ‹è¯•æ–‡ç« åˆ›å»ºæˆåŠŸï¼<br>
                        æ–‡ç« ID: ${result.id}<br>
                        å­˜å‚¨æ–¹å¼: ${hybridManager.getStorageInfo().type}
                    </div>
                `;
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        async function compareData() {
            const comparisonDiv = document.getElementById('data-comparison');
            comparisonDiv.innerHTML = '<div class="info">æ­£åœ¨å¯¹æ¯”æ•°æ®...</div>';
            
            try {
                // è·å–æœ¬åœ°æ•°æ®
                const localPosts = localManager.getPosts();
                
                // è·å–KVæ•°æ®
                let kvPosts = [];
                try {
                    const apiClient = new APIClient();
                    const response = await apiClient.getPosts();
                    kvPosts = response.posts || [];
                } catch (error) {
                    console.warn('æ— æ³•è·å–KVæ•°æ®:', error);
                }
                
                comparisonDiv.innerHTML = `
                    <div class="info">
                        <strong>æ•°æ®å¯¹æ¯”ç»“æœ:</strong><br>
                        æœ¬åœ°å­˜å‚¨æ–‡ç« æ•°: ${localPosts.length}<br>
                        äº‘ç«¯KVæ–‡ç« æ•°: ${kvPosts.length}<br><br>
                        
                        <strong>æœ¬åœ°æ–‡ç« åˆ—è¡¨:</strong>
                        <pre>${JSON.stringify(localPosts.map(p => ({id: p.id, title: p.title, createdAt: p.createdAt})), null, 2)}</pre>
                        
                        <strong>äº‘ç«¯æ–‡ç« åˆ—è¡¨:</strong>
                        <pre>${JSON.stringify(kvPosts.map(p => ({id: p.id, title: p.title, createdAt: p.createdAt})), null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                comparisonDiv.innerHTML = `<div class="error">å¯¹æ¯”å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        async function forceUseKV() {
            const resultsDiv = document.getElementById('sync-results');
            resultsDiv.innerHTML = '<div class="info">æ­£åœ¨å¼ºåˆ¶åˆ‡æ¢åˆ°KVå­˜å‚¨...</div>';
            
            try {
                hybridManager.useAPI = true;
                await hybridManager.kvManager.initialize();
                
                resultsDiv.innerHTML = '<div class="success">âœ… å·²å¼ºåˆ¶åˆ‡æ¢åˆ°KVå­˜å‚¨æ¨¡å¼</div>';
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">åˆ‡æ¢å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        async function forceUseLocal() {
            const resultsDiv = document.getElementById('sync-results');
            resultsDiv.innerHTML = '<div class="info">æ­£åœ¨å¼ºåˆ¶åˆ‡æ¢åˆ°æœ¬åœ°å­˜å‚¨...</div>';
            
            hybridManager.useAPI = false;
            resultsDiv.innerHTML = '<div class="success">âœ… å·²å¼ºåˆ¶åˆ‡æ¢åˆ°æœ¬åœ°å­˜å‚¨æ¨¡å¼</div>';
        }
        
        async function syncLocalToKV() {
            const resultsDiv = document.getElementById('sync-results');
            resultsDiv.innerHTML = '<div class="info">æ­£åœ¨åŒæ­¥æœ¬åœ°æ•°æ®åˆ°KV...</div>';
            
            try {
                const localPosts = localManager.getPosts();
                const apiClient = new APIClient();
                
                let successCount = 0;
                for (const post of localPosts) {
                    try {
                        await apiClient.createPost(post);
                        successCount++;
                    } catch (error) {
                        console.warn('åŒæ­¥æ–‡ç« å¤±è´¥:', post.title, error);
                    }
                }
                
                resultsDiv.innerHTML = `
                    <div class="success">
                        âœ… åŒæ­¥å®Œæˆï¼<br>
                        æˆåŠŸåŒæ­¥ ${successCount}/${localPosts.length} ç¯‡æ–‡ç« 
                    </div>
                `;
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">åŒæ­¥å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        async function syncKVToLocal() {
            const resultsDiv = document.getElementById('sync-results');
            resultsDiv.innerHTML = '<div class="info">æ­£åœ¨åŒæ­¥KVæ•°æ®åˆ°æœ¬åœ°...</div>';
            
            try {
                const apiClient = new APIClient();
                const response = await apiClient.getPosts();
                const kvPosts = response.posts || [];
                
                // æ¸…ç©ºæœ¬åœ°æ•°æ®
                localStorage.removeItem('blogPosts');
                
                // æ·»åŠ KVæ•°æ®åˆ°æœ¬åœ°
                for (const post of kvPosts) {
                    localManager.addPost(post);
                }
                
                resultsDiv.innerHTML = `
                    <div class="success">
                        âœ… åŒæ­¥å®Œæˆï¼<br>
                        æˆåŠŸåŒæ­¥ ${kvPosts.length} ç¯‡æ–‡ç« åˆ°æœ¬åœ°å­˜å‚¨
                    </div>
                `;
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">åŒæ­¥å¤±è´¥: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>